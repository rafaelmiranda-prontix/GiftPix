// Prisma schema for GiftPix

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Gift {
  id           String    @id @default(uuid())
  referenceId  String    @unique @map("reference_id")
  amount       Decimal   @db.Decimal(10, 2)
  status       GiftStatus @default(ACTIVE)
  message      String?
  pinHash      String    @map("pin_hash")
  expiresAt    DateTime? @map("expires_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  redemptions  GiftRedemption[]
  payments     Payment[]
  pixTransfers PixTransaction[]
  fraudEvents  FraudEvent[]

  @@index([status])
  @@index([expiresAt])
  @@map("gift")
}

model GiftRedemption {
  id              String      @id @default(uuid())
  giftId          String      @map("gift_id")
  pixKey          String      @map("pix_key")
  status          RedemptionStatus @default(PENDING)
  provider        Provider
  providerRef     String?     @map("provider_ref")
  errorMessage    String?     @map("error_message")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  gift            Gift        @relation(fields: [giftId], references: [id])

  @@map("gift_redemption")
}

model Payment {
  id              String      @id @default(uuid())
  giftId          String      @map("gift_id")
  provider        Provider
  providerRef     String?     @map("provider_ref")
  amount          Decimal     @db.Decimal(10, 2)
  status          PaymentStatus @default(PENDING)
  lastCheckedAt   DateTime?    @map("last_checked_at")
  errorMessage    String?     @map("error_message")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  gift            Gift        @relation(fields: [giftId], references: [id])

  @@map("payment")
}

model AuditLog {
  id        String   @id @default(uuid())
  entity    String
  entityId  String   @map("entity_id")
  action    String
  payload   Json
  createdAt DateTime @default(now()) @map("created_at")

  @@index([entity, createdAt])
  @@map("audit_log")
}

model TransactionLog {
  id                     String         @id @default(uuid())
  referenceId            String         @unique @map("reference_id")
  pixKey                 String         @map("pix_key")
  amount                 Decimal        @db.Decimal(10, 2)
  status                 TransactionStatus @default(PENDING)
  description            String?
  provider               Provider
  providerTransactionId  String?        @map("provider_transaction_id")
  errorMessage           String?        @map("error_message")
  createdAt              DateTime       @default(now()) @map("created_at")
  updatedAt              DateTime       @updatedAt @map("updated_at")

  @@index([providerTransactionId])
  @@index([status])
  @@map("transaction_log")
}

model PixTransaction {
  id               String      @id @default(uuid())
  giftId           String      @map("gift_id")
  pspTransactionId String      @unique @map("psp_transaction_id")
  status           PixStatus   @default(PENDING)
  lastCheckedAt    DateTime?   @map("last_checked_at")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  gift             Gift        @relation(fields: [giftId], references: [id])

  @@index([giftId])
  @@index([status])
  @@map("pix_transaction")
}

model Notification {
  id            String          @id @default(uuid())
  giftId        String?         @map("gift_id")
  type          NotificationType
  channel       NotificationChannel
  recipient     String
  status        NotificationStatus @default(PENDING)
  sentAt        DateTime?       @map("sent_at")
  createdAt     DateTime        @default(now()) @map("created_at")
  errorMessage  String?         @map("error_message")

  @@index([giftId])
  @@index([type, channel])
  @@map("notification")
}

enum NotificationType {
  GIFT_CREATED
  GIFT_REDEEMED
  GIFT_EXPIRED
}

enum NotificationChannel {
  EMAIL
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

enum GiftStatus {
  ACTIVE
  REDEEMED
  EXPIRED
  REFUNDED
}

enum RedemptionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  PROCESSING
  REFUNDED
}

enum Provider {
  ASAAS
  PAGBANK
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum PixStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

model SystemConfig {
  key        String   @id
  value      String
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("system_config")
}

model FraudEvent {
  id         String   @id @default(uuid())
  giftId     String?  @map("gift_id")
  eventType  String   @map("event_type")
  riskScore  Int      @map("risk_score")
  ip         String?
  createdAt  DateTime @default(now()) @map("created_at")

  gift       Gift?    @relation(fields: [giftId], references: [id])

  @@index([giftId])
  @@index([eventType])
  @@map("fraud_event")
}

model FraudBlock {
  id         String   @id @default(uuid())
  entityType String   @map("entity_type") // user/ip
  entityId   String   @map("entity_id")
  reason     String
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([entityType, entityId])
  @@map("fraud_block")
}
