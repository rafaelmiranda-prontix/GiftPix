// Prisma schema for GiftPix

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Gift {
  id           String    @id @default(uuid())
  referenceId  String    @unique
  amount       Decimal   @db.Decimal(10, 2)
  status       GiftStatus @default(ACTIVE)
  message      String?
  pinHash      String
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  redemptions  GiftRedemption[]
  payments     Payment[]

  @@index([status])
  @@index([expiresAt])
}

model GiftRedemption {
  id              String      @id @default(uuid())
  giftId          String
  pixKey          String
  status          RedemptionStatus @default(PENDING)
  provider        Provider
  providerRef     String?
  errorMessage    String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  gift            Gift        @relation(fields: [giftId], references: [id])
}

model Payment {
  id              String      @id @default(uuid())
  giftId          String
  provider        Provider
  providerRef     String?
  amount          Decimal     @db.Decimal(10, 2)
  status          PaymentStatus @default(PENDING)
  errorMessage    String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  gift            Gift        @relation(fields: [giftId], references: [id])
}

model AuditLog {
  id        String   @id @default(uuid())
  entity    String
  entityId  String
  action    String
  payload   Json
  createdAt DateTime @default(now())

  @@index([entity, createdAt])
}

model TransactionLog {
  id                     String         @id @default(uuid())
  referenceId            String         @unique
  pixKey                 String
  amount                 Decimal        @db.Decimal(10, 2)
  status                 TransactionStatus @default(PENDING)
  description            String?
  provider               Provider
  providerTransactionId  String?
  errorMessage           String?
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt

  @@index([providerTransactionId])
  @@index([status])
}

enum GiftStatus {
  ACTIVE
  REDEEMED
  EXPIRED
}

enum RedemptionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
}

enum Provider {
  ASAAS
  PAGBANK
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}
